# Architectural Decisions Log

## 1. Отказ от готовых Auth-библиотек
```markdown**Контекст:** Требование ТЗ — реализовать логику самостоятельно.
Решение:
    Реализован сервис `AuthService` для низкоуровневой работы с `bcrypt` и `jwt`.
    Реализован `AuthMiddleware` вместо стандартных зависимостей `OAuth2PasswordBearer`
    для полного контроля над жизненным циклом запроса и состоянием пользователя (`is_active`).
Плюсы:
    Полный контроль, отсутствие магии, возможность легкой кастомизации payload токена.
```
## 2. Матричная модель доступа (Granular RBAC)
```markdown
Контекст:
    Обычный RBAC (роль Admin/User) недостаточно гибок для сложных систем.
Решение:
    Внедрена сущность `BusinessElement` (Ресурс) и таблица связей `AccessRolesRules`.
Схема:
    `Role` -> `AccessRolesRules` (CRUD Flags) -> `BusinessElement`
Плюсы:
    Позволяет менять права без изменения кода (через БД/API).
    Позволяет гибко настраивать права (например, дать Менеджеру право удалять Заказы, но не Пользователей).
```

## 3. Разделение Global vs Local permissions
```markdown
Проблема:
    Как отличить право "Читать всё" от "Читать только своё"?
Решение:
    Разделение флагов на `read_permission` и `read_all_permission`.
    Сервис `PermissionService` сначала проверяет `_all`.
    Если `_all` ложь, проверяется обычный флаг + проверка владельца (`user.id == object.owner_id`).
```
## 4. Асинхронный стек (Async SQLAlchemy 2.0)
```markdown
Решение:
    Использование `asyncpg` и асинхронных сессий.
Причина:
    Высокая производительность I/O операций. Использование `selectinload` для оптимизации
    загрузки связей (Role, Rules) в одном запросе, чтобы избежать проблемы N+1.
```
